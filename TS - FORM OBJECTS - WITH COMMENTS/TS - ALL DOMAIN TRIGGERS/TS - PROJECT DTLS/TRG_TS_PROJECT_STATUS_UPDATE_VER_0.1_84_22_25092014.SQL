-- VERSION:0.1 --SDATE:25/09/2014 --EDATE:25/09/2014 --ISSUE:84 --COMMENTNO:22 --DESC:TRIGGERS TO UPDATE OLD & NEW VALUE IN TICKLER HISTORY PROJECT_STATUS TABLE DONE BY RL

DROP TRIGGER IF EXISTS TRG_TS_PROJECT_STATUS_UPDATE;
CREATE TRIGGER TRG_TS_PROJECT_STATUS_UPDATE  
AFTER UPDATE ON PROJECT_STATUS
FOR EACH ROW
BEGIN 
	
	DECLARE OLD_VALUE TEXT DEFAULT '';
	DECLARE NEW_VALUE TEXT DEFAULT '';
	
	IF((OLD.PS_ID!= NEW.PS_ID) OR (OLD.PD_ID!= NEW.PD_ID) OR (OLD.PC_ID!= NEW.PC_ID) OR 
	(OLD.PS_REC_VER!= NEW.PS_REC_VER) OR (OLD.PS_START_DATE!= NEW.PS_START_DATE) OR
	(OLD.PS_END_DATE!= NEW.PS_END_DATE)) THEN
		SET OLD_VALUE = CONCAT(OLD_VALUE,'PS_ID=', OLD.PS_ID,','); 
	END IF;

	IF (OLD.PD_ID!= NEW.PD_ID) THEN 
		SET OLD_VALUE = CONCAT(OLD_VALUE,'PD_ID=', OLD.PD_ID,','); 
	END IF;
	IF (OLD.PD_ID!= NEW.PD_ID) THEN   
		SET NEW_VALUE = CONCAT(NEW_VALUE,'PD_ID=', NEW.PD_ID,','); 
	END IF;

	IF (OLD.PC_ID!= NEW.PC_ID) THEN 
		SET OLD_VALUE = CONCAT(OLD_VALUE,'PC_ID=', OLD.PC_ID,','); 
	END IF;
	IF (OLD.PC_ID!= NEW.PC_ID) THEN   
		SET NEW_VALUE = CONCAT(NEW_VALUE,'PC_ID=', NEW.PC_ID,','); 
	END IF;

	IF (OLD.PS_REC_VER!= NEW.PS_REC_VER) THEN 
		SET OLD_VALUE = CONCAT(OLD_VALUE,'PS_REC_VER=', OLD.PS_REC_VER,','); 
	END IF;
	IF (OLD.PS_REC_VER!= NEW.PS_REC_VER) THEN   
		SET NEW_VALUE = CONCAT(NEW_VALUE,'PS_REC_VER=', NEW.PS_REC_VER,','); 
	END IF;

	IF (OLD.PS_START_DATE!= NEW.PS_START_DATE) THEN 
		SET OLD_VALUE = CONCAT(OLD_VALUE,'PS_START_DATE=', OLD.PS_START_DATE,','); 
	END IF;
	IF (OLD.PS_START_DATE!= NEW.PS_START_DATE) THEN   
		SET NEW_VALUE = CONCAT(NEW_VALUE,'PS_START_DATE=', NEW.PS_START_DATE,','); 
	END IF;

	IF (OLD.PS_END_DATE!= NEW.PS_END_DATE) THEN 
		SET OLD_VALUE = CONCAT(OLD_VALUE,'PS_END_DATE=', OLD.PS_END_DATE,','); 
	END IF;
	IF (OLD.PS_END_DATE!= NEW.PS_END_DATE) THEN   
		SET NEW_VALUE = CONCAT(NEW_VALUE,'PS_END_DATE=', NEW.PS_END_DATE,','); 
	END IF;
	
	IF((OLD.PS_ID!= NEW.PS_ID) OR (OLD.PD_ID!= NEW.PD_ID) OR (OLD.PC_ID!= NEW.PC_ID) OR 
	(OLD.PS_REC_VER!= NEW.PS_REC_VER) OR (OLD.PS_START_DATE!= NEW.PS_START_DATE) OR
	(OLD.PS_END_DATE!= NEW.PS_END_DATE)) THEN
		IF (OLD.ULD_ID!= NEW.ULD_ID) THEN  
			SET OLD_VALUE = CONCAT(OLD_VALUE,'ULD_ID=', OLD.ULD_ID,','); 
		END IF;
		IF (OLD.PS_TIMESTAMP!= NEW.PS_TIMESTAMP) THEN  
			SET OLD_VALUE = CONCAT(OLD_VALUE,'PS_TIMESTAMP=', OLD.PS_TIMESTAMP,','); 
		END IF;
	END IF;
	
	IF (OLD_VALUE!='' AND NEW_VALUE!='') THEN
		IF(OLD_VALUE!=NEW_VALUE)THEN
			SET OLD_VALUE = SUBSTRING(OLD_VALUE,1,CHAR_LENGTH(OLD_VALUE)-1);
			SET NEW_VALUE = SUBSTRING(NEW_VALUE,1,CHAR_LENGTH(NEW_VALUE)-1);
			INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,TH_USERSTAMP_ID) VALUES
			((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),
			(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='PROJECT_STATUS'),OLD_VALUE,NEW_VALUE,
			(SELECT ULD_ID FROM PROJECT_STATUS WHERE PD_ID=NEW.PD_ID));
		END IF;
	END IF;
END;