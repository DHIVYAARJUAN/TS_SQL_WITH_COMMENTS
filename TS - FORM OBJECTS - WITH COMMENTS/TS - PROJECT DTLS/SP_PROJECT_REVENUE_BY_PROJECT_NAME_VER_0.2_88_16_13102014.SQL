-- VER 0.2 ISSUE NO:88 COMMENT:16 STARTDATE:15/10/2014 ENDDATE:16/10/2014 DESC:ADDED 2 INPUT FOR SHOWING NO OF PROJECT COUNT & NO OF DAYS WORKED DONE BY:DHIVYA
-- version 0.1 startdate:04/10/2014 enddate:06/10/2014 ISSUE:88 CMT:12 DESC:SP FOR SHOWING NO OF DAYS A USER WORKING FOR A PROJECT DONE BY:DHIVYA

DROP PROCEDURE IF EXISTS SP_PROJECT_REVENUE_BY_PROJECT_NAME; 
CREATE PROCEDURE SP_PROJECT_REVENUE_BY_PROJECT_NAME(PROJECTNAME VARCHAR(50),USERSTAMP VARCHAR(50),OUT TEMP_PROJECT_REVENUE TEXT,OUT TOT_NO_OF_DAYS TEXT) 
BEGIN

-- VARIABLE DECLARATION
DECLARE PDID INTEGER; 
DECLARE MINID INTEGER;
DECLARE MAXID INTEGER;
DECLARE USERSTAMP_ID INTEGER;
DECLARE PROJECTREVENUE TEXT;
DECLARE LOGINID VARCHAR(40);
DECLARE NOOFDAYS INTEGER;
DECLARE MAXRECVER INTEGER;
DECLARE URCID INTEGER;
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN 
ROLLBACK;
END;
SET AUTOCOMMIT=0;
START TRANSACTION;

-- SELECTING PDID FROM PROJECT_DETAILS FOR THE INPUT PROJECT NAME
SET PDID=(SELECT PD_ID FROM PROJECT_DETAILS WHERE PD_PROJECT_NAME=PROJECTNAME);
SET @PROJECT_ID=PDID;

-- GETTING ULD_ID
CALL SP_TS_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
SET USERSTAMP_ID=(SELECT @ULDID);

SET PROJECTREVENUE=(SELECT CONCAT('TEMP_PROJECT_REVENUE','_',SYSDATE()));
SET PROJECTREVENUE=(SELECT REPLACE(PROJECTREVENUE,' ',''));
SET PROJECTREVENUE=(SELECT REPLACE(PROJECTREVENUE,'-',''));
SET PROJECTREVENUE=(SELECT REPLACE(PROJECTREVENUE,':',''));
SET TEMP_PROJECT_REVENUE=(SELECT CONCAT(PROJECTREVENUE,'_',USERSTAMP_ID));

-- DROP QUERY FOR TEMP TABLE
SET @DROP_QUERY=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_PROJECT_REVENUE));
PREPARE DROP_QUERY_STMT FROM @DROP_QUERY;
EXECUTE DROP_QUERY_STMT;
DEALLOCATE PREPARE DROP_QUERY_STMT;

-- CREATE TABLE QUERY FOR TEMPTABLE FOR INSERING LOGINID AND NOOF DAYS WORKED FOR PROJECT
SET @CREATE_QUERY=(SELECT CONCAT('CREATE TABLE ',TEMP_PROJECT_REVENUE,'(ID INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,USERNAME VARCHAR(40),TOT_NO_OF_DAYS INTEGER)'));
PREPARE CREATE_QUERY_STMT FROM @CREATE_QUERY;
EXECUTE CREATE_QUERY_STMT;
DEALLOCATE PREPARE CREATE_QUERY_STMT;

-- SET MINID FOR TEMP_TABLE
SET @SET_MINID=(SELECT CONCAT('SELECT MIN(ULD_ID) INTO @MIN_ID FROM USER_LOGIN_DETAILS'));
PREPARE SET_MINID_STMT FROM @SET_MINID;
EXECUTE SET_MINID_STMT;
DEALLOCATE PREPARE SET_MINID_STMT;

SET MINID=@MIN_ID;
-- SET MAXID FOR TEMP_TABLE
SET @SET_MAXID=(SELECT CONCAT('SELECT MAX(ULD_ID) INTO @MAX_ID FROM USER_LOGIN_DETAILS'));
PREPARE SET_MAXID_STMT FROM @SET_MAXID;
EXECUTE SET_MAXID_STMT;
DEALLOCATE PREPARE SET_MAXID_STMT;

SET MAXID=@MAX_ID;

	WHILE MINID<=MAXID DO
		-- QUERY FOR GETTING USERNAME;
		SET LOGINID=(SELECT ULD_LOGINID FROM USER_LOGIN_DETAILS WHERE ULD_ID=MINID);
		SET MAXRECVER=(SELECT MAX(UA_REC_VER) FROM USER_ACCESS WHERE ULD_ID=MINID);
		SET URCID=(SELECT URC.URC_ID FROM USER_RIGHTS_CONFIGURATION URC,ROLE_CREATION RC,USER_ACCESS UA WHERE URC.URC_ID=RC.URC_ID AND UA.RC_ID=RC.RC_ID AND UA.ULD_ID=MINID AND UA_REC_VER=MAXRECVER);
	IF LOGINID IS NOT NULL THEN
		IF URCID!=2 THEN

			-- QUERY FOR GETTING NO OF DAYS A USER WORKING IN A PROJECT
			SET @SETNOOFDAYS=(SELECT CONCAT('SELECT  COUNT(UARD_PDID) INTO @NO_OF_DAYS FROM USER_ADMIN_REPORT_DETAILS WHERE ((UARD_PDID LIKE ','"','%,',PDID,',%','"',') OR (UARD_PDID LIKE ','"','%,',PDID,'"',') OR (UARD_PDID=',PDID,')) AND (ULD_ID=',MINID,')'));
			PREPARE SETNOOFDAYSSTMT FROM @SETNOOFDAYS;
			EXECUTE SETNOOFDAYSSTMT;
			DEALLOCATE PREPARE SETNOOFDAYSSTMT;
			SET NOOFDAYS=@NO_OF_DAYS;

			-- QUERY FOR INSERTING USERNAME,NO OF DAYS A USER WORKING IN A PROJECT
			IF NOOFDAYS>0 THEN
			SET @INSERT_TEMP_TABLE=(SELECT CONCAT('INSERT INTO ',TEMP_PROJECT_REVENUE,'(USERNAME,TOT_NO_OF_DAYS)VALUES(','"',LOGINID,'"',',',NOOFDAYS,')'));
			PREPARE INSERT_TEMP_TABLE_STMT FROM @INSERT_TEMP_TABLE;
			EXECUTE INSERT_TEMP_TABLE_STMT;
			END IF;
		END IF;
	END IF;
	SET @NO_OF_DAYS=NULL;
	SET MINID=MINID+1;
	END WHILE;
	SET @SET_TOT_NOOF_DAYS=(SELECT CONCAT('SELECT COUNT(DISTINCT(UARD_DATE)) INTO @COUNT_DAYS FROM USER_ADMIN_REPORT_DETAILS WHERE ((UARD_PDID LIKE ','"','%,',PDID,',%','"',') OR (UARD_PDID LIKE ','"','%,',PDID,'"',') OR (UARD_PDID=',PDID,'))'));
	PREPARE SET_TOT_NOOF_DAYS_STMT FROM @SET_TOT_NOOF_DAYS;
	EXECUTE SET_TOT_NOOF_DAYS_STMT;
	SET TOT_NO_OF_DAYS=@COUNT_DAYS;
COMMIT;
END;

/* CALL SP_PROJECT_REVENUE_BY_PROJECT_NAME('EI','dhivya.arjunan@ssomens.com',@TEMP_PROJECT_REVENUE);
SELECT @TEMP_PROJECT_REVENUE; 
