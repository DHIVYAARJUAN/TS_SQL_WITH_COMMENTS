--VERSION:0.1 --SDATE:29/09/2014 --EDATE:29/09/2014 --ISSUE:89 --COMMENT NO#1 --DESC:SP TO INSERT,UPDATE IN PROJECT DTLS,PROJECTS STATUS TABLE --DONE BY :RL
DROP PROCEDURE IF EXISTS SP_TS_PROJECT_DETAILS_INSERT_UPDATE;
CREATE PROCEDURE SP_TS_PROJECT_DETAILS_INSERT_UPDATE(
IN PROJECTID INTEGER,
IN PROJECT_NAME VARCHAR(50),
IN PROJECT_DESCRIPTION VARCHAR(100),
IN PSID INTEGER,
IN STATUS TEXT,
IN START_DATE DATE,
IN END_DATE DATE,
IN USERSTAMP VARCHAR(50),
IN PROCESS TEXT,
OUT SUCCESS_FLAG TEXT)

BEGIN
	
	DECLARE USERSTAMP_ID INTEGER;
	DECLARE STATUS_ID INTEGER;
	DECLARE PDID INTEGER;
	DECLARE REC_VER INTEGER;

	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN
		ROLLBACK;
		SET SUCCESS_FLAG = '';
	END;

	SET AUTOCOMMIT = 0;
	START TRANSACTION;

	SET SUCCESS_FLAG = '';

	CALL SP_TS_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
	SET USERSTAMP_ID = (SELECT @ULDID);

	SET STATUS_ID = (SELECT PC_ID FROM PROJECT_CONFIGURATION WHERE PC_DATA = STATUS);

	SET PDID = (SELECT DISTINCT(PD_ID) FROM PROJECT_STATUS WHERE PD_ID = (SELECT PD_ID FROM 
	PROJECT_DETAILS WHERE PD_PROJECT_NAME = PROJECT_NAME));

	SET REC_VER = (SELECT MAX(PS_REC_VER) FROM PROJECT_STATUS WHERE PD_ID = (SELECT PD_ID FROM 
	PROJECT_DETAILS WHERE PD_PROJECT_NAME = PROJECT_NAME));

	IF(PROCESS='INSERT') OR (PROCESS='UPDATE')THEN

		IF (PROJECT_NAME IS NOT NULL) THEN
			
			IF (PROJECT_NAME REGEXP BINARY '[a-z]') THEN
				
				SET SUCCESS_FLAG = (SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=38);
			
			END IF;
		
		END IF;
		
		IF (PROJECT_DESCRIPTION IS NOT NULL) THEN
			
			IF (PROJECT_DESCRIPTION REGEXP BINARY '[a-z]') THEN
				
				SET SUCCESS_FLAG=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=39);
		
			END IF;
		
		END IF;

	END IF;

	IF(PROCESS = 'INSERT') THEN

		IF NOT EXISTS(SELECT PD_PROJECT_NAME FROM PROJECT_DETAILS WHERE PD_PROJECT_NAME = PROJECT_NAME)THEN
		
			IF(PROJECTID=0 AND PROJECT_NAME IS NOT NULL AND PROJECT_DESCRIPTION IS NOT NULL AND USERSTAMP IS NOT NULL) THEN

				INSERT INTO PROJECT_DETAILS(PD_PROJECT_NAME,PD_PROJECT_DESCRIPTION,ULD_ID) VALUES
				(PROJECT_NAME,PROJECT_DESCRIPTION,USERSTAMP_ID);
				SET SUCCESS_FLAG = 1;
		
			END IF;

		END IF;

		IF(PDID IS NULL AND STATUS_ID = 1) THEN

			IF(PSID=0 AND PROJECT_NAME IS NOT NULL AND STATUS IS NOT NULL AND START_DATE IS NOT NULL AND END_DATE
			IS NOT NULL AND USERSTAMP IS NOT NULL) THEN
				
				INSERT INTO PROJECT_STATUS (PD_ID,PC_ID,PS_REC_VER,PS_START_DATE,PS_END_DATE,ULD_ID) VALUES
				((SELECT PD_ID FROM PROJECT_DETAILS WHERE PD_PROJECT_NAME = PROJECT_NAME),
				(SELECT PC_ID FROM PROJECT_CONFIGURATION WHERE PC_DATA = STATUS),1,START_DATE,END_DATE,USERSTAMP_ID);
				SET SUCCESS_FLAG = 1;

			END IF;

		END IF;

		IF(PDID IS NOT NULL AND STATUS_ID = 2) THEN

			IF(PSID=0 AND PROJECT_NAME IS NOT NULL AND STATUS IS NOT NULL AND START_DATE IS NOT NULL AND END_DATE
			IS NOT NULL AND USERSTAMP IS NOT NULL) THEN
				
				INSERT INTO PROJECT_STATUS (PD_ID,PC_ID,PS_REC_VER,PS_START_DATE,PS_END_DATE,ULD_ID) VALUES
				((SELECT PD_ID FROM PROJECT_DETAILS WHERE PD_PROJECT_NAME = PROJECT_NAME),
				(SELECT PC_ID FROM PROJECT_CONFIGURATION WHERE PC_DATA = STATUS),(REC_VER+1),START_DATE,END_DATE,USERSTAMP_ID);
				SET SUCCESS_FLAG = 1;

			END IF;

		END IF;

	END IF;	

	IF(PROCESS = 'UPDATE') THEN

		IF(PROJECTID!=0 AND PROJECT_NAME IS NOT NULL AND PROJECT_DESCRIPTION IS NOT NULL AND USERSTAMP IS NOT NULL) THEN

			UPDATE PROJECT_DETAILS SET PD_PROJECT_NAME = PROJECT_NAME, PD_PROJECT_DESCRIPTION = PROJECT_DESCRIPTION,
			ULD_ID = USERSTAMP_ID WHERE PD_ID = PROJECTID;
			SET SUCCESS_FLAG = 1;
		
		END IF;

		IF(PSID!=0 AND PROJECT_NAME IS NOT NULL AND STATUS IS NOT NULL AND START_DATE IS NOT NULL AND END_DATE
		IS NOT NULL AND USERSTAMP IS NOT NULL) THEN

		

				UPDATE PROJECT_STATUS SET PC_ID = (SELECT PC_ID FROM PROJECT_CONFIGURATION WHERE PC_DATA = STATUS),
				PS_START_DATE = START_DATE,PS_END_DATE = END_DATE , ULD_ID = USERSTAMP_ID WHERE PS_ID = PSID;
				SET SUCCESS_FLAG = 1;

		

		END IF;

	END IF;	

	COMMIT;

END;